# ====================================================================
# GNN配体受体预测模型配置文件
# 基于图神经网络(GNN)的配体受体相互作用预测模型的完整配置
# ====================================================================

# ====================================================================
# 数据配置 - 定义数据路径、预处理参数和数据集划分
# ====================================================================
data:
  data_dir: "../data"                    # 数据根目录，存放所有输入数据文件
                                        # 可通过--test参数自动切换到testdata目录进行测试
  file_format: "csv"                    # 数据文件格式：csv 或 h5；可用 --file-format 覆盖
  
  gene_expr_path: "../data/x.csv"       # 基因表达数据文件路径
                                        # 格式：行为样本，列为基因，包含基因表达量数值
  
  lr_scores_path: "../data/y.csv"       # 配体受体相互作用评分数据文件路径
                                        # 格式：行为样本，列为配体受体对，包含相互作用强度评分
  
  pathway_path: "../data/pathway_gene.csv"  # 通路基因映射文件路径
                                           # 格式：定义基因与生物通路的对应关系
  padj_path: null                         # 分类任务下的padj矩阵路径（可选）
  h5_keys:                               # 当 file_format=h5 时的键名（可用命令行覆盖）
    x: "x"                               # x.h5 中的表达矩阵键名
    y: "y"                               # y.h5 中的回归标签键名
    padj: "padj"                         # padj.h5 中的分类标签键名
  
  train_ratio: 0.7                      # 训练集比例 (70%)
  val_ratio: 0.15                       # 验证集比例 (15%)
  test_ratio: 0.15                      # 测试集比例 (15%)
  
  random_seed: 42                       # 随机种子，确保数据划分的可重复性
  
  lr_normalize_method: "log1p"          # LR评分归一化方法，用于稳定训练过程
                                        # 选项：
                                        # - "none": 不进行归一化
                                        # - "log1p": log(1+x)变换，适合稀疏数据
                                        # - "standard": 标准化 (z-score)
                                        # - "minmax": 最小最大归一化

# ====================================================================
# 模型配置 - 定义GNN模型架构和网络参数
# ====================================================================
model:
  num_genes: 5051                       # 基因总数，需与输入数据的基因数量一致
  num_lr_pairs: 1120                    # 配体受体对总数，需与输出目标数量一致
  
  gene_embedding_dim: 128                # 基因嵌入维度，控制基因特征表示的复杂度
                                        # 较大值可捕获更复杂特征，但增加计算成本
  
  hidden_dim: 128                       # 隐藏层维度，影响模型的表达能力
                                        # 通常设为embedding_dim的1-4倍
  
  gat_layers: 3                         # 图注意力网络(GAT)层数
                                        # 更多层可捕获更远距离的基因相互作用
  
  attention_heads: 4                    # 多头注意力机制的头数
                                        # 增加头数可提高模型对不同特征的关注能力
  
  dropout: 0.1                          # Dropout比例，防止过拟合
                                        # 范围：0.0-0.5，值越大正则化越强
  
  pathway_aggregation: "attention"      # 特征聚合方法
                                        # 选项：
                                        # - "attention": 基于注意力的加权聚合
                                        # - "mean": 简单平均聚合
                                        # - "max": 最大值聚合

# ====================================================================
# 训练配置 - 定义训练过程的超参数和策略
# ====================================================================
training:
  batch_size: 64                         # 批次大小，影响训练稳定性和内存使用
                                        # 较大值训练更稳定，但需要更多GPU内存
  
  epochs: 100                           # 最大训练轮数
                                        # 实际训练可能因早停机制提前结束
  
  learning_rate: 0.001                  # 初始学习率，控制参数更新步长
                                        # 过大可能导致不收敛，过小训练缓慢
  
  weight_decay: 0.0001                  # L2正则化系数，防止过拟合
                                        # 较大值增强正则化效果
  
  patience: 15                          # 早停耐心值，验证集性能不提升的最大轮数
                                        # 超过此轮数将自动停止训练
  
  min_delta: 0.001                      # 早停最小改善阈值
                                        # 验证集性能改善小于此值视为无改善
  
  gradient_clip: 1.0                    # 梯度裁剪阈值，防止梯度爆炸
                                        # 将梯度范数限制在此值以内

# ====================================================================
# GPU配置 - 定义GPU使用和并行计算设置
# ====================================================================
gpu:
  use_gpu: true                         # 是否使用GPU加速训练
                                        # false时使用CPU训练（速度较慢）
  
  device_ids: [4]                    # 使用的GPU设备ID列表
                                        # 支持多GPU训练，如[0,1,2,3]
  
  mixed_precision: true                 # 是否启用混合精度训练
                                        # 可显著减少GPU内存使用并加速训练
  
  num_workers: 2                        # 数据加载的并行进程数
                                        # 通常设为CPU核心数的1/2到1倍
  
  pin_memory: true                      # 是否将数据固定在内存中
                                        # 可加速GPU数据传输，但增加内存使用

# ====================================================================
# 优化器配置 - 定义参数优化算法和相关参数
# ====================================================================
optimizer:
  type: "adam"                          # 优化器类型
                                        # 选项：
                                        # - "adam": 自适应学习率，适合大多数情况
                                        # - "adamw": Adam的改进版，更好的权重衰减
                                        # - "sgd": 随机梯度下降，需要精细调参
  
  betas: [0.9, 0.999]                   # Adam优化器的动量参数
                                        # beta1控制梯度的指数移动平均
                                        # beta2控制梯度平方的指数移动平均
  
  eps: 0.00000001                       # 数值稳定性参数，防止除零错误

# ====================================================================
# 学习率调度 - 定义学习率变化策略
# ====================================================================
scheduler:
  type: "cosine"                        # 学习率调度器类型
                                        # 选项：
                                        # - "cosine": 余弦退火，平滑降低学习率
                                        # - "step": 阶梯式降低
                                        # - "plateau": 基于验证集性能自适应调整
  
  warmup_epochs: 10                     # 预热轮数，学习率从0逐渐增加到初始值
                                        # 有助于训练初期的稳定性
  
  min_lr: 0.000001                      # 最小学习率，防止学习率过小导致训练停滞

# ====================================================================
# 评估配置 - 定义模型性能评估指标和输出设置
# ====================================================================
evaluation:
  metrics: ["mse", "mae", "r2", "pearson", "accuracy_micro", "accuracy_macro", "f1_micro", "f1_macro", "roc_auc_macro", "precision_micro", "precision_macro", "recall_micro", "recall_macro"]  # 评估指标列表（支持回归与分类）
                                            # 回归：mse, mae, r2, pearson
                                            # 分类：accuracy_micro/accuracy_macro, f1_micro/f1_macro, roc_auc_macro, precision_micro/precision_macro, recall_micro/recall_macro
  
  save_predictions: true                # 是否保存模型预测结果到文件
  generate_lr_scatter: false            # 是否生成逐LR散点图（默认关闭）
  visual_rank_metric: auc               # lr_classification可视化排序依据：auc 或 ap
  top_k_lr_visuals: 50                  # 仅展示排序靠前的前K个LR目标
  min_pos_ratio_for_visuals: 0.05       # 至少需要的正样本比例（如5%），过滤极端不平衡

# ====================================================================
# 交叉验证配置 - 定义模型泛化性能评估设置
# ====================================================================
cross_validation:
  default_folds: 5                      # 默认交叉验证折数
                                        # 5折交叉验证是常用设置，平衡计算成本和评估可靠性
  
  default_type: "kfold"                 # 交叉验证类型
                                        # 选项：
                                        # - "kfold": 标准K折交叉验证
                                        # - "stratified": 分层K折，保持类别分布
  
  save_models: false                    # 是否保存每折训练的模型
                                        # true会占用大量存储空间
  
  random_seed: 42                       # 交叉验证的随机种子，确保可重复性

# ====================================================================
# 超参数优化配置 - 定义自动超参数搜索设置
# ====================================================================
hyperopt:
  n_trials: 50                          # 超参数搜索的试验次数
                                        # 更多试验可能找到更好的参数组合
  
  timeout: 3600                         # 超参数搜索的最大时间限制（秒）
                                        # 3600秒 = 1小时
  
  search_space:                         # 超参数搜索空间定义
    gene_embedding_dim: [64, 128, 256]      # 基因嵌入维度候选值
    hidden_dim: [128, 256, 512]             # 隐藏层维度候选值
    gat_layers: [2, 3, 4]                   # GAT层数候选值
    attention_heads: [4, 8, 16]             # 注意力头数候选值
    learning_rate: [0.0001, 0.01]           # 学习率搜索范围
    dropout: [0.05, 0.3]                    # Dropout比例搜索范围
    batch_size: [32, 64, 128]               # 批次大小候选值

# ====================================================================
# 输出配置 - 定义模型保存和日志输出路径
# ====================================================================
output:
  model_dir: "./models3"                 # 训练好的模型保存目录
  log_dir: "./logs"                     # 训练日志保存目录
  result_dir: "./results3"               # 评估结果保存目录
  cv_result_dir: "./results3/cross_validation"  # 交叉验证结果保存目录
  
  checkpoint_freq: 10                   # 模型检查点保存频率（每N个epoch保存一次）
  save_best_only: true                  # 是否只保存验证集性能最好的模型
                                        # true可节省存储空间，false保留训练历史

# ====================================================================
# 任务类型与分类配置 - 定义是否为分类任务，以及padj阈值与预测阈值
# ====================================================================
task_type: classification                   # 可选：regression 或 classification
classification:
  padj_threshold: 0.05                  # padj阈值，小于等于此值标记为阳性（1）
  pred_threshold: 0.5                   # 推理时概率阈值，将概率转换为0/1
  use_pos_weight_loss: true             # 分类任务启用按目标的正类加权损失
  threshold_objective: ap_f1               # 阈值优化目标：可选 f1 | fbeta | ap | ap_f1
  fbeta: 1.0                            # 当 threshold_objective=fbeta 时生效；β=1 等价 F1
  threshold_range: [0.05, 0.95, 19]     # f1/fbeta 扫描范围；ap 模式按曲线点阈值
